<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>CNNs, Part 1: An Introduction to Convolutional Neural Networks - victorzhou.com</title>
    <link>https://victorzhou.com/blog/intro-to-cnns-part-1/</link>
    <description>Single Medium article feed</description>

    <item>
      <title>CNNs, Part 1: An Introduction to Convolutional Neural Networks - victorzhou.com</title>
      <link>https://victorzhou.com/blog/intro-to-cnns-part-1/</link>
      <description><![CDATA[
<article class="Content-module--content--EnZoh"><h1 class="Content-module--content__title--2nRHa">CNNs, Part 1: An Introduction to Convolutional Neural Networks</h1><h2 class="Content-module--content__subtitle--34jJU">A simple guide to what CNNs are, how they work, and how to build one from scratch in Python.</h2><div class="Content-module--content__date--38AD1"><p class="ContentDate-module--content-date--12EjD"><time>May 22, 2019</time><span class="ContentDate-module--date-modified--CK-rT"> | UPDATED <time>November 10, 2019</time></span></p></div><div class="Content-module--content__spacer--2kN9Y"></div><div class="Content-module--content__body--2iuct"><p>There’s been a lot of buzz about Convolution Neural Networks (CNNs) in the past few years, especially because of how they’ve revolutionized the field of <a href="https://en.wikipedia.org/wiki/Computer_vision" rel="noopener noreferrer" target="_blank">Computer Vision</a>. In this post, we’ll build on a basic background knowledge of neural networks and <strong>explore what CNNs are, understand how they work, and build a real one from scratch</strong> (using only <a href="https://www.numpy.org/" rel="noopener noreferrer" target="_blank">numpy</a>) in Python.</p>
<p><strong>This post assumes only a basic knowledge of neural networks</strong>. My <a href="/blog/intro-to-neural-networks/">introduction to Neural Networks</a> covers everything you’ll need to know, so you might want to read that first.</p>
<p>Ready? Let’s jump in.</p>
<h2 id="1-motivation" style="position:relative"><a aria-label="1 motivation permalink" class="anchor before" href="#1-motivation"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>1. Motivation</h2>
<p>A classic use case of CNNs is to perform image classification, e.g. looking at an image of a pet and deciding whether it’s a cat or a dog. It’s a seemingly simple task - <strong>why not just use a normal Neural Network?</strong></p>
<p>Good question.</p>
<h3 id="reason-1-images-are-big" style="position:relative"><a aria-label="reason 1 images are big permalink" class="anchor before" href="#reason-1-images-are-big"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Reason 1: Images are Big</h3>
<p>Images used for Computer Vision problems nowadays are often 224x224 or larger. Imagine building a neural network to process 224x224 color images: including the 3 color channels (RGB) in the image, that comes out to 224 x 224 x 3 = <strong>150,528</strong> input features! A typical hidden layer in such a network might have 1024 nodes, so we’d have to train 150,528 x 1024 = <strong>150+ million weights for the first layer alone</strong>. Our network would be <em>huge</em> and nearly impossible to train.</p>
<p>It’s not like we need that many weights, either. The nice thing about images is that we know <strong>pixels are most useful in the context of their neighbors</strong>. Objects in images are made up of small, <em>localized</em> features, like the circular iris of an eye or the square corner of a piece of paper. Doesn’t it seem wasteful for <em>every</em> node in the first hidden layer to look at <em>every</em> pixel?</p>
<h3 id="reason-2-positions-can-change" style="position:relative"><a aria-label="reason 2 positions can change permalink" class="anchor before" href="#reason-2-positions-can-change"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Reason 2: Positions can change</h3>
<p>If you trained a network to detect dogs, you’d want it to be able to a detect a dog <em>regardless of where it appears in the image</em>. Imagine training a network that works well on a certain dog image, but then feeding it a slightly shifted version of the same image. The dog would not activate the same neurons, so <strong>the network would react completely differently!</strong></p>
<p>We’ll see soon how a CNN can help us mitigate these problems.</p>
<h2 id="2-dataset" style="position:relative"><a aria-label="2 dataset permalink" class="anchor before" href="#2-dataset"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>2. Dataset</h2>
<p>In this post, we’ll tackle the “Hello, World!” of Computer Vision: the <a href="http://yann.lecun.com/exdb/mnist/" rel="noopener noreferrer" target="_blank">MNIST</a> handwritten digit classification problem. It’s simple: given an image, classify it as a digit.</p>
<p></p><figure class="gatsby-resp-image-figure">
<span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:594px">
<span class="gatsby-resp-image-background-image" style="padding-bottom:60.57142857142858%;position:relative;bottom:0;left:0;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACrElEQVQozy2T2W5SYRSFzwN4411rjW/jUIdEJfoGxmgaDTdGa6Iv0FjFQChCWwJtGcopSKUU9KCMhcpcKAXaMrSUoRQewe9vvPjzD3utvdfa+xypUqlczefzH6PR6ItcLvfu6OhoptFoqOPx+PtAIPC81Wp9SKfTz7LZ7GyhUFBXq1X12dnZG+4vuc/Cn+H8NplMvlIU5bXUbDavn5ycpA4ODtYg/wG8zn2TFeXN2ul0kmDM7BGKeUVsOBwGwdrBRii+zjlULBY3jo+PPRKkyXa7vclFy+4sl8sLAJZPT0/lvb09DWeRZB6iq1QqLYkYiURxXa1Wc+FugZijXq9/GwwGJgmbkxD9SNYjfwP5RohW3r9HIhEtqnyZTEYD2cObBYyV4g6RKJVKeeCZKCgTX0KcWaLaFMri4XDYiuxfEOxY9FD1N4WE1Rhvi+whVLkp4Dk8PPTjZLXb7YboqZ1YELwTniydn59fw14okUgsAvBBsEBwUnX7vw2FxHrufgo7hD2hdjweL8P1w7EQ+wFv5eLiYk0i+wQJ3Ts7Oxp2GxPVYccE0Mk+3+/3N/b39+dEMhIbUWGiiAU3X3u9ngOFOjCip3rcGsRQpqgkbFk4/0SVDZBbTI59mcpRCplQpYhJ8qm4wW7R5xUKKfTRRm8D9F6od0nIvZwylbUkuJwylc0kkIlp+ES8sVjsswCzhE2zmLJwwpLBG3ApkhnhLUpMbIJkwtYXwGu7u7taMTneHKj4NBqNZKY8h1I7Uzfy8RrBWVCkAWOnLTpiqyw9TgwSw7iBzTJ2PPTtLyp93EOoy9IzGeslYk528mYUEoRQGAfnZc8Q2yJxCkfb8IMSaq5weYr025Aeo3gamw9og4rEtwA/4be8iR0V078PScQegr3DWUU/p4k9wvJdFN77B2Zk+KZQwgFtAAAAAElFTkSuQmCC');background-size:cover;display:block"></span>
<picture>
<source sizes="(max-width: 594px) 100vw, 594px" srcset="/static/16ddab2ee3bcd9e22d96f267e473a2f4/9cece/mnist-examples.webp 175w, /static/16ddab2ee3bcd9e22d96f267e473a2f4/adf5f/mnist-examples.webp 350w, /static/16ddab2ee3bcd9e22d96f267e473a2f4/e4151/mnist-examples.webp 594w" type="image/webp"/>
<source sizes="(max-width: 594px) 100vw, 594px" srcset="/static/16ddab2ee3bcd9e22d96f267e473a2f4/1aaec/mnist-examples.png 175w, /static/16ddab2ee3bcd9e22d96f267e473a2f4/98287/mnist-examples.png 350w, /static/16ddab2ee3bcd9e22d96f267e473a2f4/d369c/mnist-examples.png 594w" type="image/png"/>
<img alt="Sample images from the MNIST dataset" class="gatsby-resp-image-image" loading="lazy" src="/static/16ddab2ee3bcd9e22d96f267e473a2f4/d369c/mnist-examples.png" style="max-width:100%;height:auto;margin:8px 0;" title="Sample images from the MNIST dataset"/>
</picture>
</span>
<figcaption class="gatsby-resp-image-figcaption">Sample images from the MNIST dataset</figcaption>
</figure><p></p>
<p>Each image in the MNIST dataset is 28x28 and contains a centered, grayscale digit.</p>
<p>Truth be told, a normal neural network would actually work just fine for this problem. You could treat each image as a 28 x 28 = 784-dimensional vector, feed that to a 784-dim input layer, stack a few hidden layers, and finish with an output layer of 10 nodes, 1 for each digit.</p>
<p>This would only work because the MNIST dataset contains <strong>small</strong> images that are <strong>centered</strong>, so we wouldn’t run into the aforementioned issues of size or shifting. Keep in mind throughout the course of this post, however, that <strong>most real-world image classification problems aren’t this easy.</strong></p>
<p>Enough buildup. Let’s get into CNNs!</p>
<h2 id="3-convolutions" style="position:relative"><a aria-label="3 convolutions permalink" class="anchor before" href="#3-convolutions"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>3. Convolutions</h2>
<p>What are Convolutional Neural Networks?</p>
<p>They’re basically just neural networks that use <strong>Convolutional layers</strong>, a.k.a. Conv layers, which are based on the mathematical operation of <a href="https://en.wikipedia.org/wiki/Convolution" rel="noopener noreferrer" target="_blank">convolution</a>. Conv layers consist of a set of <strong>filters</strong>, which you can think of as just 2d matrices of numbers. Here’s an example 3x3 filter:</p>
<p></p><figure><img src="/687f9b9f24fc4f9a50b30e8a1f4d3686/vertical-sobel.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>A 3x3 filter</figcaption></figure><p></p>
<p>We can use an input image and a filter to produce an output image by <strong>convolving</strong> the filter with the input image. This consists of</p>
<ol>
<li>Overlaying the filter on top of the image at some location.</li>
<li>Performing <strong>element-wise multiplication</strong> between the values in the filter and their corresponding values in the image.</li>
<li>Summing up all the element-wise products. This sum is the output value for the <strong>destination pixel</strong> in the output image.</li>
<li>Repeating for all locations.</li>
</ol>
<blockquote>
<p>Side Note: We (along with many CNN implementations) are technically actually using <a href="https://en.wikipedia.org/wiki/Cross-correlation" rel="noopener noreferrer" target="_blank">cross-correlation</a> instead of convolution here, but they do almost the same thing. I won’t go into the difference in this post because it’s not that important, but feel free to look this up if you’re curious.</p>
</blockquote>
<p>That 4-step description was a little abstract, so let’s do an example. Consider this tiny 4x4 grayscale image and this 3x3 filter:</p>
<p></p><figure><img src="/media/cnn-post/convolve-example-1.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>A 4x4 image (left) and a 3x3 filter (right)</figcaption></figure><p></p>
<p>The numbers in the image represent pixel intensities, where 0 is black and 255 is white. We’ll convolve the input image and the filter to produce a 2x2 output image:</p>
<p></p><figure><img src="/media/cnn-post/example-output.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>A 2x2 output image</figcaption></figure><p></p>
<p>To start, lets overlay our filter in the top left corner of the image:</p>
<p></p><figure><img src="/media/cnn-post/convolve-example-2.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>Step 1: Overlay the filter (right) on top of the image (left)</figcaption></figure><p></p>
<p>Next, we perform element-wise multiplication between the overlapping image values and filter values. Here are the results, starting from the top left corner and going right, then down:</p>
<table><thead><tr><th>Image Value</th><th>Filter Value</th><th>Result</th></tr></thead><tbody><tr><td>0</td><td>-1</td><td>0</td></tr><tr><td>50</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>0</td></tr><tr><td>0</td><td>-2</td><td>0</td></tr><tr><td>80</td><td>0</td><td>0</td></tr><tr><td>31</td><td>2</td><td>62</td></tr><tr><td>33</td><td>-1</td><td>-33</td></tr><tr><td>90</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>0</td></tr></tbody></table>
<figcaption>Step 2: Performing element-wise multiplication.</figcaption>
<p>Next, we sum up all the results. That’s easy enough:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>62</mn><mo>−</mo><mn>33</mn><mo>=</mo><menclose notation="box"><mstyle displaystyle="false" scriptlevel="0"><mstyle displaystyle="true" scriptlevel="0"><mn>29</mn></mstyle></mstyle></menclose></mrow><annotation encoding="application/x-tex">62 - 33 = \boxed{29}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">6</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">3</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.32444em;vertical-align:-0.33999999999999997em"></span><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9844400000000001em"><span style="top:-3.32444em"><span class="pstrut" style="height:3.32444em"></span><span class="mord boxpad"><span class="mord"><span class="mord">2</span><span class="mord">9</span></span></span></span><span style="top:-2.98444em"><span class="pstrut" style="height:3.32444em"></span><span class="stretchy fbox" style="height:1.32444em"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.33999999999999997em"><span></span></span></span></span></span></span></span></span></span>
<p>Finally, we place our result in the destination pixel of our output image. Since our filter is overlayed in the top left corner of the input image, our destination pixel is the top left pixel of the output image:</p>
<p><img src="/media/cnn-post/convolve-output-1.svg" style="max-width:100%;height:auto;margin:8px 0;"/></p>
<p>We do the same thing to generate the rest of the output image:</p>
<p><img src="/69b4c1dd078ee363317bb8fa323eaace/convolve-output.gif" style="max-width:100%;height:auto;margin:8px 0;"/></p>
<h3 id="31-how-is-this-useful" style="position:relative"><a aria-label="31 how is this useful permalink" class="anchor before" href="#31-how-is-this-useful"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>3.1 How is this useful?</h3>
<p>Let’s zoom out for a second and see this at a higher level. What does convolving an image with a filter do? We can start by using the example 3x3 filter we’ve been using, which is commonly known as the vertical <a href="https://en.wikipedia.org/wiki/Sobel_operator" rel="noopener noreferrer" target="_blank">Sobel filter</a>:</p>
<p></p><figure><img src="/media/cnn-post/vertical-sobel.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>The vertical Sobel filter</figcaption></figure><p></p>
<p>Here’s an example of what the vertical Sobel filter does:</p>
<p></p><figure class="gatsby-resp-image-figure">
<span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:700px">
<span class="gatsby-resp-image-background-image" style="padding-bottom:50.28571428571429%;position:relative;bottom:0;left:0;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA3XAAAN1wFCKJt4AAACn0lEQVQozzWS3UuTYRjGX9Tp5qYzvzbT5XRafjGDygMLSiKIJDN9zQ3d1KkZziVWhoPUPjXLrJDs0yI6iCIyySg10gRFTUKjgw5Kheqs/+HX+zzRwc3Nc3D/nuu6r1v51RNgvFRlttLFcn0dS8camat0s3S0gV/9bXy71EZfwQGMeiO6cB0RERGEhobKCgsLQ6/XExISQmRkpHwrK34vbw+WMXVIZcbjY3noOiv3h5h21/C1qYaXrmrqHfuwJSURoQ0LgICKHh4ejtlslqXT6UhMTESZdruYKKtgsrSC2bpGVh8OsjY1xpfbN1m83k9XoZsX9U1kpm/SgAZiY2MxmUwSKpRFRUURHx9PXFwcFosFZcFXxfjhcuYbqlls8vNIbeNddy+rb54y0tHFreIalq90kmy1oDdEymEBTEhIwGq1SrCA2my2f5bnfB4mNeDHKi/nd1RxZmctnweuMXfuAoHUvUycPMHMuSA26z/LFs1WkmY/OztbAgU8NTVVfqAoCsq4q5Jpr4+zhfX48yp433yc7x1Bxjx+LhaqfDofZObyaTLS7ZhjYrClpJCbm0taWhpGo5Ho6Gjy8/MxGAxSrTJadoRXbj+nClvpKark9X6VP8HTDO+r1ux7Wek/w88Pg+TlZmt7iicrKwun00mKBhaKxAoyMzNlyiIkZcTt4UFJHZ0HOjm53UVvVhE/2k9xo9jLYw24dKObhTvdbEnPwLoxScKSk5NliaRFECJdsUehWBltCXB1dxkNzlradzVwr2A/6+0B1p/dZaSllZWBdp6UqGzP34Z5QwwOh0OqzMnJkacioEJljLYOCRxra+XKHhXPZhdBZwnzFSprzT5+Dw8w0dXJc1Wlb3c5W/OcmKJMEmi322Ug/w9cgEQoov8FgydyLauXMJEAAAAASUVORK5CYII=');background-size:cover;display:block"></span>
<picture>
<source sizes="(max-width: 700px) 100vw, 700px" srcset="/static/44a1ff59f9a2c7f62cf9f56a8398efd0/9cece/lenna%2Bvertical.webp 175w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/adf5f/lenna%2Bvertical.webp 350w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/fa73e/lenna%2Bvertical.webp 700w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/47a22/lenna%2Bvertical.webp 800w" type="image/webp"/>
<source sizes="(max-width: 700px) 100vw, 700px" srcset="/static/44a1ff59f9a2c7f62cf9f56a8398efd0/1aaec/lenna%2Bvertical.png 175w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/98287/lenna%2Bvertical.png 350w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/39600/lenna%2Bvertical.png 700w, /static/44a1ff59f9a2c7f62cf9f56a8398efd0/7842b/lenna%2Bvertical.png 800w" type="image/png"/>
<img alt="lenna vertical" class="gatsby-resp-image-image" loading="lazy" src="/static/44a1ff59f9a2c7f62cf9f56a8398efd0/39600/lenna%2Bvertical.png" style="max-width:100%;height:auto;margin:8px 0;" title="An image convolved with the vertical Sobel filter"/>
</picture>
</span>
<figcaption class="gatsby-resp-image-figcaption">An image convolved with the vertical Sobel filter</figcaption>
</figure><p></p>
<p>Similarly, there’s also a horizontal Sobel filter:</p>
<p></p><figure><img src="/media/cnn-post/horizontal-sobel.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>The horizontal Sobel filter</figcaption></figure><p></p>
<p></p><figure class="gatsby-resp-image-figure">
<span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:700px">
<span class="gatsby-resp-image-background-image" style="padding-bottom:50.28571428571429%;position:relative;bottom:0;left:0;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA3XAAAN1wFCKJt4AAACeklEQVQozz2SSU+TURhGv450oHawoSwIXSDiwrASF9VEidGgIkNtpQ20QCliKEgYAwYQHEAFAaNiHHBYGaMRjRgFTEANBJEoEBcuVFjgzv9w/O6NuHjz3s09Oc9zr7LRV89kUYC5khDLVZUsnapmviTM0sk4G4ONfO9r4lLOYfQaPVqdFp1OJ0ev18sRZ41GQ1JSEh6PB2UlEeXNMT8zhQE+RGIsjw6zcneU2XA532rKeR4qI77tEC7bFpR/F81m8/9tMpnkdrvdWCwWlNlwiCl/kOmiIHOV1fy6f521mQlWb11jcXiQbl+Yp7Ea3I5kFEXBpIKsVquECIDRaMRut2Oz2dBqtSifYqVMFh9nIV7GYk2CB4FG3p7t59frx4y3d3Mzv4KvlztJVk02DYVNZmYmKSkpEp6WliZNRXRlPhZhWgW+L41yLqeUzj0VfBm6ynzveeq9B5hqbuJj7xkVaJaGoiev1yu30+mUIwyFnbBVJkMlzEZj9PiqSOwM8q72ND/aO5iIJLjgC/C5t525gXbsNqsa0UpWVpY0czgcMqaAGQwG+TgS+NJ/ghfhBC2+BvpyS3iVF+BPRxtjB8vU+FFWBjvZmLnBVpdd7c0izTIyMmSHYjaBwlBGHg9HuFdQSdeRLpp3hejfkcvP1hZGjkZ5pAKXRnpYGO3CrtrZnQ7S09NlTNGdMBRbmAmoy+VSDevqGdjnJ55dQeveOHd257HeWs/6k9uM1zWwOtzGw/xiLAYzySrAo8ZNTU2VANGpiLr5dYStMtHYwJX9ASLbQ3RkF7AQDLBWG+P32BBT3Z08Cwa56CvEphoak4yyOxFbfBkRU4yAiV6F8V9VAGmsOjoEPgAAAABJRU5ErkJggg==');background-size:cover;display:block"></span>
<picture>
<source sizes="(max-width: 700px) 100vw, 700px" srcset="/static/342e8364a392ac2cbcd4ecc7b9aacaa1/9cece/lenna%2Bhorizontal.webp 175w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/adf5f/lenna%2Bhorizontal.webp 350w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/fa73e/lenna%2Bhorizontal.webp 700w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/47a22/lenna%2Bhorizontal.webp 800w" type="image/webp"/>
<source sizes="(max-width: 700px) 100vw, 700px" srcset="/static/342e8364a392ac2cbcd4ecc7b9aacaa1/1aaec/lenna%2Bhorizontal.png 175w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/98287/lenna%2Bhorizontal.png 350w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/39600/lenna%2Bhorizontal.png 700w, /static/342e8364a392ac2cbcd4ecc7b9aacaa1/7842b/lenna%2Bhorizontal.png 800w" type="image/png"/>
<img alt="lenna horizontal" class="gatsby-resp-image-image" loading="lazy" src="/static/342e8364a392ac2cbcd4ecc7b9aacaa1/39600/lenna%2Bhorizontal.png" style="max-width:100%;height:auto;margin:8px 0;" title="An image convolved with the horizontal Sobel filter"/>
</picture>
</span>
<figcaption class="gatsby-resp-image-figcaption">An image convolved with the horizontal Sobel filter</figcaption>
</figure><p></p>
<p>See what’s happening? <strong>Sobel filters are edge-detectors</strong>. The vertical Sobel filter detects vertical edges, and the horizontal Sobel filter detects horizontal edges. The output images are now easily interpreted: a bright pixel (one that has a high value) in the output image indicates that there’s a strong edge around there in the original image.</p>
<p>Can you see why an edge-detected image might be more useful than the raw image? Think back to our MNIST handwritten digit classification problem for a second. A CNN trained on MNIST might look for the digit 1, for example, by using an edge-detection filter and checking for two prominent vertical edges near the center of the image. In general, <strong>convolution helps us look for specific localized image features</strong> (like edges) that we can use later in the network.</p>
<h3 id="32-padding" style="position:relative"><a aria-label="32 padding permalink" class="anchor before" href="#32-padding"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>3.2 Padding</h3>
<p>Remember convolving a 4x4 input image with a 3x3 filter earlier to produce a 2x2 output image? Often times, we’d prefer to have the output image be the same size as the input image. To do this, we add zeros around the image so we can overlay the filter in more places. A 3x3 filter requires 1 pixel of padding:</p>
<p></p><figure><img src="/media/cnn-post/padding.svg" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>A 4x4 input convolved with a 3x3 filter to produce a 4x4 output using same padding</figcaption></figure><p></p>
<p>This is called <strong>“same” padding</strong>, since the input and output have the same dimensions. Not using any padding, which is what we’ve been doing and will continue to do for this post, is sometimes referred to as <strong>“valid” padding</strong>.</p>
<h3 id="33-conv-layers" style="position:relative"><a aria-label="33 conv layers permalink" class="anchor before" href="#33-conv-layers"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>3.3 Conv Layers</h3>
<p>Now that we know how image convolution works and why it’s useful, let’s see how it’s actually used in CNNs. As mentioned before, CNNs include <strong>conv layers</strong> that use a set of filters to turn input images into output images. A conv layer’s primary parameter is the <strong>number of filters</strong> it has.</p>
<p>For our MNIST CNN, we’ll use a small conv layer with 8 filters as the initial layer in our network. This means it’ll turn the 28x28 input image into a 26x26x8 output <strong>volume</strong>:</p>
<p><img src="/media/cnn-post/cnn-dims-1.svg" style="max-width:100%;height:auto;margin:8px 0;"/></p>
<blockquote>
<p>Reminder: The output is 26x26x8 and not 28x28x8 because we’re using <strong>valid padding</strong>, which decreases the input’s width and height by 2.</p>
</blockquote>
<p>Each of the 8 filters in the conv layer produces a 26x26 output, so stacked together they make up a 26x26x8 volume. All of this happens because of 3 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em"></span><span class="mord">×</span></span></span></span> 3 (filter size) <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em"></span><span class="mord">×</span></span></span></span> 8 (number of filters)  = <strong>only 72 weights</strong>!</p>
<h3 id="34-implementing-convolution" style="position:relative"><a aria-label="34 implementing convolution permalink" class="anchor before" href="#34-implementing-convolution"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>3.4 Implementing Convolution</h3>
<p>Time to put what we’ve learned into code! We’ll implement a conv layer’s feedforward portion, which takes care of convolving filters with an input image to produce an output volume. For simplicity, we’ll assume filters are always 3x3 (which is not true - 5x5 and 7x7 filters are also very common).</p>
<p>Let’s start implementing a conv layer class:</p>
<div class="gatsby-code-header"><h5>conv.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">Conv3x3</span><span class="token punctuation">:</span>
  <span class="token comment"># A Convolution layer using 3x3 filters.</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_filters<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>num_filters <span class="token operator">=</span> num_filters

    <span class="token comment"># filters is a 3d array with dimensions (num_filters, 3, 3)</span>
    <span class="token comment"># We divide by 9 to reduce the variance of our initial values</span>
    self<span class="token punctuation">.</span>filters <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>num_filters<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span></code></pre></div>
<p>The <code class="language-text">Conv3x3</code> class takes only one argument: the number of filters. In the constructor, we store the number of filters and initialize a random filters array using NumPy’s <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.randn.html" rel="noopener noreferrer" target="_blank">randn()</a> method.</p>
<blockquote>
<p>Note: Diving by 9 during the initialization is more important than you may think. If the initial values are too large or too small, training the network will be ineffective. To learn more, read about <a href="https://www.quora.com/What-is-an-intuitive-explanation-of-the-Xavier-Initialization-for-Deep-Neural-Networks" rel="noopener noreferrer" target="_blank">Xavier Initialization</a>.</p>
</blockquote>
<p>Next, the actual convolution:</p>
<div class="gatsby-code-header"><h5>conv.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Conv3x3</span><span class="token punctuation">:</span>
  <span class="token comment"># ...</span>

  <span class="token keyword">def</span> <span class="token function">iterate_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''</span>
<span class="token triple-quoted-string string">    Generates all possible 3x3 image regions using valid padding.</span>
<span class="token triple-quoted-string string">    - image is a 2d numpy array</span>
<span class="token triple-quoted-string string">    '''</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>h <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>w <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        im_region <span class="token operator">=</span> image<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">:</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">yield</span> im_region<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j

  <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''</span>
<span class="token triple-quoted-string string">    Performs a forward pass of the conv layer using the given input.</span>
<span class="token triple-quoted-string string">    Returns a 3d numpy array with dimensions (h, w, num_filters).</span>
<span class="token triple-quoted-string string">    - input is a 2d numpy array</span>
<span class="token triple-quoted-string string">    '''</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>shape
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_filters<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> im_region<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> self<span class="token punctuation">.</span>iterate_regions<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">      output<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>im_region <span class="token operator">*</span> self<span class="token punctuation">.</span>filters<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
    <span class="token keyword">return</span> output</code></pre></div>
<p><code class="language-python">iterate_regions<span class="token punctuation">(</span><span class="token punctuation">)</span></code> is a helper <a href="https://wiki.python.org/moin/Generators" rel="noopener noreferrer" target="_blank">generator</a> method that yields all valid 3x3 image regions for us. This will be useful for implementing the backwards portion of this class later on.</p>
<p>The line of code that actually performs the convolutions is highlighted above. Let’s break it down:</p>
<ul>
<li>We have <code class="language-text">im_region</code>, a 3x3 array containing the relevant image region.</li>
<li>We have <code class="language-text">self.filters</code>, a 3d array.</li>
<li>We do <code class="language-python">im_region <span class="token operator">*</span> self<span class="token punctuation">.</span>filters</code>, which uses numpy’s <a href="https://numpy.org/doc/stable/user/basics.broadcasting.html" rel="noopener noreferrer" target="_blank">broadcasting</a> feature to element-wise multiply the two arrays. The result is a 3d array with the same dimension as <code class="language-text">self.filters</code>.</li>
<li>We <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.sum.html" rel="noopener noreferrer" target="_blank">np.sum()</a> the result of the previous step using <code class="language-python">axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code>, which produces a 1d array of length <code class="language-text">num_filters</code> where each element contains the convolution result for the corresponding filter.</li>
<li>We assign the result to <code class="language-python">output<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span></code>, which contains convolution results for pixel <code class="language-python"><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span></code> in the output.</li>
</ul>
<p>The sequence above is performed for each pixel in the output until we obtain our final output volume! Let’s give our code a test run:</p>
<div class="gatsby-code-header"><h5>cnn.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> mnist
<span class="token keyword">from</span> conv <span class="token keyword">import</span> Conv3x3

<span class="token comment"># The mnist package handles the MNIST dataset for us!</span>
<span class="token comment"># Learn more at https://github.com/datapythonista/mnist</span>
train_images <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train_images<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_labels <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train_labels<span class="token punctuation">(</span><span class="token punctuation">)</span>

conv <span class="token operator">=</span> Conv3x3<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> conv<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>train_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># (26, 26, 8)</span></code></pre></div>
<p>Looks good so far.</p>
<blockquote>
<p>Note: in our <code class="language-text">Conv3x3</code> implementation, we assume the input is a <strong>2d</strong> numpy array for simplicity, because that’s how our MNIST images are stored. This works for us because we use it as the first layer in our network, but most CNNs have many more Conv layers. If we were building a bigger network that needed to use <code class="language-text">Conv3x3</code> multiple times, we’d have to make the input be a <strong>3d</strong> numpy array.</p>
</blockquote>
<h2 id="4-pooling" style="position:relative"><a aria-label="4 pooling permalink" class="anchor before" href="#4-pooling"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>4. Pooling</h2>
<p>Neighboring pixels in images tend to have similar values, so conv layers will typically also produce similar values for neighboring pixels in outputs. As a result, <strong>much of the information contained in a conv layer’s output is redundant</strong>. For example, if we use an edge-detecting filter and find a strong edge at a certain location, chances are that we’ll also find relatively strong edges at locations 1 pixel shifted from the original one. However, <strong>these are all the same edge!</strong> We’re not finding anything new.</p>
<p>Pooling layers solve this problem. All they do is reduce the size of the input it’s given by (you guessed it) <em>pooling</em> values together in the input. The pooling is usually done by a simple operation like <code class="language-text">max</code>, <code class="language-text">min</code>, or <code class="language-text">average</code>. Here’s an example of a Max Pooling layer with a pooling size of 2:</p>
<p></p><figure><img src="/ac441205fd06dc037b3db2dbf05660f7/pool.gif" style="max-width:100%;height:auto;margin:8px 0;"/><figcaption>Max Pooling (pool size 2) on a 4x4 image to produce a 2x2 output</figcaption></figure><p></p>
<p>To perform <em>max</em> pooling, we traverse the input image in 2x2 blocks (because pool size = 2) and put the <em>max</em> value into the output image at the corresponding pixel. That’s it!</p>
<p><strong>Pooling divides the input’s width and height by the pool size</strong>. For our MNIST CNN, we’ll place a Max Pooling layer with a pool size of 2 right after our initial conv layer. The pooling layer will transform a 26x26x8 input into a 13x13x8 output:</p>
<p><img src="/media/cnn-post/cnn-dims-2.svg" style="max-width:100%;height:auto;margin:8px 0;"/></p>
<h3 id="41-implementing-pooling" style="position:relative"><a aria-label="41 implementing pooling permalink" class="anchor before" href="#41-implementing-pooling"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>4.1 Implementing Pooling</h3>
<p>We’ll implement a <code class="language-text">MaxPool2</code> class with the same methods as our conv class from the previous section:</p>
<div class="gatsby-code-header"><h5>maxpool.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">MaxPool2</span><span class="token punctuation">:</span>
  <span class="token comment"># A Max Pooling layer using a pool size of 2.</span>

  <span class="token keyword">def</span> <span class="token function">iterate_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''</span>
<span class="token triple-quoted-string string">    Generates non-overlapping 2x2 image regions to pool over.</span>
<span class="token triple-quoted-string string">    - image is a 2d numpy array</span>
<span class="token triple-quoted-string string">    '''</span>
    h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> _ <span class="token operator">=</span> image<span class="token punctuation">.</span>shape
    new_h <span class="token operator">=</span> h <span class="token operator">//</span> <span class="token number">2</span>
    new_w <span class="token operator">=</span> w <span class="token operator">//</span> <span class="token number">2</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>new_h<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>new_w<span class="token punctuation">)</span><span class="token punctuation">:</span>
        im_region <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>j <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">(</span>j <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">yield</span> im_region<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j

  <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''</span>
<span class="token triple-quoted-string string">    Performs a forward pass of the maxpool layer using the given input.</span>
<span class="token triple-quoted-string string">    Returns a 3d numpy array with dimensions (h / 2, w / 2, num_filters).</span>
<span class="token triple-quoted-string string">    - input is a 3d numpy array with dimensions (h, w, num_filters)</span>
<span class="token triple-quoted-string string">    '''</span>
    h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> num_filters <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>shape
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> num_filters<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> im_region<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> self<span class="token punctuation">.</span>iterate_regions<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">      output<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>amax<span class="token punctuation">(</span>im_region<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
    <span class="token keyword">return</span> output</code></pre></div>
<p>This class works similarly to the <code class="language-text">Conv3x3</code> class we implemented previously. The critical line is again highlighted: to find the max from a given image region, we use <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.amax.html" rel="noopener noreferrer" target="_blank">np.amax()</a>, numpy’s array max method. We set <code class="language-python">axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code> because we only want to maximize over the first two dimensions, height and width, and not the third, <code class="language-text">num_filters</code>.</p>
<p>Let’s test it!</p>
<div class="gatsby-code-header"><h5>cnn.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> mnist
<span class="token keyword">from</span> conv <span class="token keyword">import</span> Conv3x3
<span class="token keyword">from</span> maxpool <span class="token keyword">import</span> MaxPool2

<span class="token comment"># The mnist package handles the MNIST dataset for us!</span>
<span class="token comment"># Learn more at https://github.com/datapythonista/mnist</span>
train_images <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train_images<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_labels <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train_labels<span class="token punctuation">(</span><span class="token punctuation">)</span>

conv <span class="token operator">=</span> Conv3x3<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
pool <span class="token operator">=</span> MaxPool2<span class="token punctuation">(</span><span class="token punctuation">)</span>

output <span class="token operator">=</span> conv<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>train_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> pool<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># (13, 13, 8)</span></code></pre></div>
<p>Our MNIST CNN is starting to come together!</p>
<h2 id="5-softmax" style="position:relative"><a aria-label="5 softmax permalink" class="anchor before" href="#5-softmax"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>5. Softmax</h2>
<p>To complete our CNN, we need to give it the ability to actually make predictions. We’ll do that by using the standard final layer for a multiclass classification problem: the <strong>Softmax</strong> layer, a fully-connected (dense) layer that uses the <a href="/blog/softmax/">Softmax function</a> as its activation.</p>
<blockquote>
<p>Reminder: fully-connected layers have every node connected to every output from the previous layer. We used fully-connected layers in my <a href="/blog/intro-to-neural-networks/">intro to Neural Networks</a> if you need a refresher.</p>
</blockquote>
<p>If you haven’t heard of Softmax before, read my <a href="/blog/softmax/">quick introduction to Softmax</a> before continuing.</p>
<h3 id="51-usage" style="position:relative"><a aria-label="51 usage permalink" class="anchor before" href="#51-usage"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>5.1 Usage</h3>
<p>We’ll use a softmax layer with <strong>10 nodes, one representing each digit,</strong> as the final layer in our CNN. Each node in the layer will be connected to every input. After the softmax transformation is applied, <strong>the digit represented by the node with the highest probability</strong> will be the output of the CNN!</p>
<p><img src="/media/cnn-post/cnn-dims-3.svg" style="max-width:100%;height:auto;margin:8px 0;"/></p>
<h3 id="52-cross-entropy-loss" style="position:relative"><a aria-label="52 cross entropy loss permalink" class="anchor before" href="#52-cross-entropy-loss"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>5.2 Cross-Entropy Loss</h3>
<p>You might have just thought to yourself, <span class="emph-special">why bother transforming the outputs into probabilities? Won’t the highest output value always have the highest probability?</span> If you did, you’re absolutely right. <strong>We don’t actually need to use softmax to predict a digit</strong> - we could just pick the digit with the highest output from the network!</p>
<p>What softmax really does is help us <strong>quantify how sure we are of our prediction</strong>, which is useful when training and evaluating our CNN. More specifically, using softmax lets us use <strong>cross-entropy loss</strong>, which takes into account how sure we are of each prediction. Here’s how we calculate cross-entropy loss:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>=</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L = -\ln(p_c)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathdefault">c</span></span></span></span> is the correct class (in our case, the correct digit), <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">p_c</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> is the predicted probability for class <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathdefault">c</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ln</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\ln</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mop">ln</span></span></span></span> is the <a href="https://en.wikipedia.org/wiki/Natural_logarithm" rel="noopener noreferrer" target="_blank">natural log</a>. As always, a lower loss is better. For example, in the best case, we’d have</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi>L</mi><mo>=</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">p_c = 1, L = -\ln(1) = 0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span>
<p>In a more realistic case, we might have</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub><mo>=</mo><mn>0.8</mn><mo separator="true">,</mo><mi>L</mi><mo>=</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0.8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.223</mn></mrow><annotation encoding="application/x-tex">p_c = 0.8, L = -\ln(0.8) = 0.223</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">2</span><span class="mord">3</span></span></span></span></span>
<p>We’ll be seeing cross-entropy loss again later on in this post, so keep it in mind!</p>
<h3 id="53-implementing-softmax" style="position:relative"><a aria-label="53 implementing softmax permalink" class="anchor before" href="#53-implementing-softmax"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>5.3 Implementing Softmax</h3>
<p>You know the drill by now - let’s implement a <code class="language-text">Softmax</code> layer class:</p>
<div class="gatsby-code-header"><h5>softmax.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">Softmax</span><span class="token punctuation">:</span>
  <span class="token comment"># A standard fully-connected layer with softmax activation.</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_len<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># We divide by input_len to reduce the variance of our initial values</span>
    self<span class="token punctuation">.</span>weights <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>input_len<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span> <span class="token operator">/</span> input_len
    self<span class="token punctuation">.</span>biases <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Performs a forward pass of the softmax layer using the given input.
    Returns a 1d numpy array containing the respective probability values.
    - input can be any array with any dimensions.
    '''</span>
    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>

    input_len<span class="token punctuation">,</span> nodes <span class="token operator">=</span> self<span class="token punctuation">.</span>weights<span class="token punctuation">.</span>shape

    totals <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>weights<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>biases
    exp <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>totals<span class="token punctuation">)</span>
    <span class="token keyword">return</span> exp <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre></div>
<p>There’s nothing too complicated here. A few highlights:</p>
<ul>
<li>We <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.flatten.html" rel="noopener noreferrer" target="_blank">flatten()</a> the input to make it easier to work with, since we no longer need its shape.</li>
<li><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.dot.html" rel="noopener noreferrer" target="_blank">np.dot()</a> multiplies <code class="language-text">input</code> and <code class="language-text">self.weights</code> element-wise and then sums the results.</li>
<li><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.exp.html" rel="noopener noreferrer" target="_blank">np.exp()</a> calculates the exponentials used for Softmax.</li>
</ul>
<p>We’ve now completed the entire forward pass of our CNN! Putting it together:</p>
<div class="gatsby-code-header"><h5>cnn.py</h5></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> mnist
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> conv <span class="token keyword">import</span> Conv3x3
<span class="token keyword">from</span> maxpool <span class="token keyword">import</span> MaxPool2
<span class="token keyword">from</span> softmax <span class="token keyword">import</span> Softmax

<span class="token comment"># We only use the first 1k testing examples (out of 10k total)</span>
<span class="token comment"># in the interest of time. Feel free to change this if you want.</span>
test_images <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test_images<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span>
test_labels <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test_labels<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span>

conv <span class="token operator">=</span> Conv3x3<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>                  <span class="token comment"># 28x28x1 -&gt; 26x26x8</span>
pool <span class="token operator">=</span> MaxPool2<span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment"># 26x26x8 -&gt; 13x13x8</span>
softmax <span class="token operator">=</span> Softmax<span class="token punctuation">(</span><span class="token number">13</span> <span class="token operator">*</span> <span class="token number">13</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 13x13x8 -&gt; 10</span>

<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">'''
  Completes a forward pass of the CNN and calculates the accuracy and
  cross-entropy loss.
  - image is a 2d numpy array
  - label is a digit
  '''</span>
  <span class="token comment"># We transform the image from [0, 255] to [-0.5, 0.5] to make it easier</span>
  <span class="token comment"># to work with. This is standard practice.</span>
  out <span class="token operator">=</span> conv<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">(</span>image <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
  out <span class="token operator">=</span> pool<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
  out <span class="token operator">=</span> softmax<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

  <span class="token comment"># Calculate cross-entropy loss and accuracy. np.log() is the natural log.</span>
  loss <span class="token operator">=</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>out<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span>
  acc <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">==</span> label <span class="token keyword">else</span> <span class="token number">0</span>

  <span class="token keyword">return</span> out<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> acc

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'MNIST CNN initialized!'</span><span class="token punctuation">)</span>

loss <span class="token operator">=</span> <span class="token number">0</span>
num_correct <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>im<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># Do a forward pass.</span>
  _<span class="token punctuation">,</span> l<span class="token punctuation">,</span> acc <span class="token operator">=</span> forward<span class="token punctuation">(</span>im<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
  loss <span class="token operator">+=</span> l
  num_correct <span class="token operator">+=</span> acc

  <span class="token comment"># Print stats every 100 steps.</span>
  <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">99</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>
      <span class="token string">'[Step %d] Past 100 steps: Average Loss %.3f | Accuracy: %d%%'</span> <span class="token operator">%</span>
      <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> loss <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span> num_correct<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    loss <span class="token operator">=</span> <span class="token number">0</span>
    num_correct <span class="token operator">=</span> <span class="token number">0</span></code></pre></div>
<p>Running <code class="language-text">cnn.py</code> gives us output similar to this:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">MNIST CNN initialized!
[Step 100] Past 100 steps: Average Loss 2.302 | Accuracy: 11%
[Step 200] Past 100 steps: Average Loss 2.302 | Accuracy: 8%
[Step 300] Past 100 steps: Average Loss 2.302 | Accuracy: 3%
[Step 400] Past 100 steps: Average Loss 2.302 | Accuracy: 12%</code></pre></div>
<p>This makes sense: with random weight initialization, you’d expect the CNN to be only as good as random guessing. Random guessing would yield 10% accuracy (since there are 10 classes) and a cross-entropy loss of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo>−</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0.1</mn><mo stretchy="false">)</mo></mrow><mo>=</mo><mn>2.302</mn></mrow><annotation encoding="application/x-tex">{-\ln(0.1)} = 2.302</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">2</span><span class="mord">.</span><span class="mord">3</span><span class="mord">0</span><span class="mord">2</span></span></span></span>, which is what we get!</p>
<p><strong>Want to try or tinker with this code yourself? <a href="https://repl.it/@vzhou842/A-CNN-from-scratch-Part-1" rel="noopener noreferrer" target="_blank">Run this CNN in your browser</a>.</strong> It’s also available on <a href="https://github.com/vzhou842/cnn-from-scratch/tree/forward-only" rel="noopener noreferrer" target="_blank">Github</a>.</p>
<h2 id="6-conclusion" style="position:relative"><a aria-label="6 conclusion permalink" class="anchor before" href="#6-conclusion"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>6. Conclusion</h2>
<p>That’s the end of this introduction to CNNs! In this post, we</p>
<ul>
<li>Motivated why CNNs might be more useful for certain problems, like image classification.</li>
<li>Introduced the <strong>MNIST</strong> handwritten digit dataset.</li>
<li>Learned about <strong>Conv layers</strong>, which convolve filters with images to produce more useful outputs.</li>
<li>Talked about <strong>Pooling layers</strong>, which can help prune everything but the most useful features.</li>
<li>Implemented a <strong>Softmax</strong> layer so we could use <strong>cross-entropy loss</strong>.</li>
</ul>
<p>There’s still much more that we haven’t covered yet, such as how to actually train a CNN. <strong><a href="/blog/intro-to-cnns-part-2/">Part 2</a> of this CNN series does a deep-dive on training a CNN</strong>, including deriving gradients and implementing backprop. Alternatively, you can also learn to <a href="/blog/keras-cnn-tutorial/">implement your own CNN with Keras</a>, a deep learning library for Python, or read the rest of my <a href="/series/neural-networks-from-scratch/">Neural Networks from Scratch</a> series.</p>
<p>If you’re eager to see a trained CNN in action: this <a href="https://keras.io/examples/vision/mnist_convnet/" rel="noopener noreferrer" target="_blank">example Keras CNN</a> trained on MNIST achieves <strong>99%</strong> accuracy. CNNs are powerful!</p></div></article>
      ]]></description>
      <pubDate>Wed, 05 Nov 2025 08:20:32 GMT</pubDate>
    </item>
  </channel>
</rss>
